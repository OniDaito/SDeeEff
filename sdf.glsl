#version 300 es

precision mediump float;

// Blackle's cool shader
// https://www.shadertoy.com/view/wtVyWK


uniform float   u_time;
uniform vec2    u_resolution;

in vec2 out_texcoord;
layout(location = 0) out vec4 out_colour; // out_color must be written in order to see anything

vec3 erot(vec3 p, vec3 ax, float ro) {
    return mix(dot(p,ax)*ax,p,cos(ro))+sin(ro)*cross(ax,p);
}

float scene(vec3 p) {
    //sdf is undefined outside the unit sphere, uncomment to witness the abominations
    if (length(p) > 10.) {
        return length(p)-.8;
    }
    //neural networks can be really compact... when they want to be
vec4 f0_0=sin(p.y*vec4(-.41,3.05,3.00,-2.75)+p.z*vec4(1.06,-3.08,-1.39,2.45)+p.x*vec4(1.73,-3.67,-.55,2.64)+vec4(4.39,3.34,-1.46,6.55));
vec4 f0_1=sin(p.y*vec4(-3.12,-3.94,-2.35,-1.15)+p.z*vec4(-.03,-1.03,1.36,2.01)+p.x*vec4(1.84,-3.13,3.32,-1.58)+vec4(-4.07,3.55,2.20,6.58));
vec4 f0_2=sin(p.y*vec4(-1.07,-.78,-1.73,-2.03)+p.z*vec4(-3.62,-3.55,-1.29,-1.74)+p.x*vec4(.62,3.72,4.28,-2.83)+vec4(-.66,7.08,5.24,1.72));
vec4 f0_3=sin(p.y*vec4(-.56,-3.34,2.95,1.23)+p.z*vec4(1.27,-.24,-.41,-3.83)+p.x*vec4(-.99,.61,2.22,-2.04)+vec4(-7.68,.34,-.54,6.98));
vec4 f1_0=sin(mat4(.41,-.31,-.42,-.69,.13,-.05,.40,-.31,.44,-.40,-.36,.84,-.36,.32,.36,.32)*f0_0+
    mat4(-.09,.33,-.05,-.39,-.22,-.04,.37,.42,.12,.05,.33,.03,.32,-.17,-.46,-.67)*f0_1+
    mat4(-.06,-.23,.06,.20,.10,.10,.13,-.32,-.02,.06,-.24,.28,-.43,-.35,-.10,.40)*f0_2+
    mat4(-.30,-.15,.10,-.09,.14,.64,.23,-.13,.20,.31,.22,-.30,-.23,-.18,.18,-.04)*f0_3+
    vec4(-1.86,1.98,2.39,-1.36))/1.0+f0_0;
vec4 f1_1=sin(mat4(-.43,.08,.27,-.37,-.02,.00,-.17,-.05,.73,-.52,-.30,-.21,.37,.35,.07,-.02)*f0_0+
    mat4(.18,-.09,-.11,-.31,.20,.23,.18,.32,.15,-.28,.55,.62,.30,-.16,.20,-.02)*f0_1+
    mat4(.01,.11,.28,.00,-.05,-.08,-.15,-.00,-.34,-.14,-.18,.16,.03,-.49,-.52,-.22)*f0_2+
    mat4(-.58,-.29,.49,-.13,-.34,-.57,.63,.64,-.15,.11,-.50,-.22,.22,.14,-.05,-.12)*f0_3+
    vec4(1.60,-1.83,-.91,1.39))/1.0+f0_1;
vec4 f1_2=sin(mat4(-.38,-.74,-.43,-.22,.07,.12,.11,.40,-.25,.68,-.21,.48,-.30,-.33,-.11,-.31)*f0_0+
    mat4(.36,-.16,-.18,-.08,-.07,-.08,-.04,.33,-.59,-.30,-.46,-.57,-.48,-.30,-.12,.18)*f0_1+
    mat4(.41,.01,.20,.11,-.22,.23,-.67,-.21,-.31,.87,.20,.51,.26,-.18,.67,-.01)*f0_2+
    mat4(-.04,-.28,-.91,.52,.85,-.90,.44,-.01,-.37,.09,-.64,.33,.03,-.23,-.27,.13)*f0_3+
    vec4(-1.96,-1.47,3.36,-.11))/1.0+f0_2;
vec4 f1_3=sin(mat4(.77,-.52,-.51,.32,-.15,-.08,.15,-.11,.07,.15,-.08,-.02,-.31,-.07,.33,-.02)*f0_0+
    mat4(.01,.12,.42,-.91,-.45,-.15,-.25,-.28,.24,-.34,.19,.39,.10,.30,.31,-.61)*f0_1+
    mat4(.03,-.26,-.12,.04,.21,-.10,.15,-.12,-.31,-.47,.13,.61,.10,-.22,-.02,.40)*f0_2+
    mat4(-.08,-.18,.48,.26,.29,.29,.21,.19,.41,-.33,.00,.20,-.03,.04,.24,-.05)*f0_3+
    vec4(-.33,-.60,-3.44,1.02))/1.0+f0_3;
vec4 f2_0=sin(mat4(-.10,-.37,-.61,.44,-.03,.04,.21,-.02,.12,-.28,-.05,.07,-.17,.25,.45,-.57)*f1_0+
    mat4(.05,-.08,.32,.04,-.05,-.53,.07,.06,.45,-.34,.46,-.19,-.33,-.35,-.51,.14)*f1_1+
    mat4(-.15,-.01,.18,.28,-.08,.13,.02,-.22,-.36,-.07,-.39,-.43,-.05,.54,-.81,-.25)*f1_2+
    mat4(-.71,.07,-.88,.45,-.34,.38,.39,.09,.13,-.46,.63,.33,.20,-.30,.35,-.67)*f1_3+
    vec4(3.15,2.29,-2.39,3.25))/1.4+f1_0;
vec4 f2_1=sin(mat4(.19,.14,-.34,.60,.10,-.12,-.28,.33,.20,-.09,-.03,.42,.03,-.58,.34,.04)*f1_0+
    mat4(.28,-.42,-.34,-.07,.41,.29,.24,-.45,-.29,.39,.10,.09,-.72,-.20,-.52,.44)*f1_1+
    mat4(-.03,.11,.01,.13,-.20,-.28,-.12,-.26,-.81,-.48,-.30,.46,.16,-.27,-.13,-.28)*f1_2+
    mat4(.43,-.55,.77,-.01,.22,-.07,.02,.14,.33,-.05,.08,.06,.25,-.04,-.04,-.14)*f1_3+
    vec4(.87,-.22,-.78,3.17))/1.4+f1_1;
vec4 f2_2=sin(mat4(-.84,-.36,.36,.05,.40,-.33,.05,-.08,.28,-.35,.08,-.61,.30,-.44,-.10,-.22)*f1_0+
    mat4(.04,-.10,.38,.28,.16,.72,-.40,.37,-.57,-.47,-.03,-.25,.72,-.23,-.78,-.14)*f1_1+
    mat4(.44,.41,-.01,-.55,.23,.18,-.30,.07,-.39,-.22,-.42,-.00,-.09,.45,.69,-.46)*f1_2+
    mat4(-.35,.99,.13,-.11,.60,-.15,.56,-.48,-.18,-.55,-.16,.17,-.10,.39,.19,.40)*f1_3+
    vec4(1.68,-1.39,-2.06,-.51))/1.4+f1_2;
vec4 f2_3=sin(mat4(-.08,.51,.35,.52,-.04,.23,.13,.33,-.10,.37,-.03,.66,.54,-.44,-.25,.31)*f1_0+
    mat4(.22,-.19,.69,.74,-.18,.08,.33,-.12,.00,.20,-.48,.43,-.06,-.46,-.30,-.42)*f1_1+
    mat4(.18,-.25,-.04,-.36,.30,-.51,.18,.12,-.45,.26,-.15,-.01,-.01,.19,.14,-.02)*f1_2+
    mat4(-.01,.59,-.07,.17,.49,-.24,.48,.46,-.32,-.03,-.36,-.45,.19,-.26,-.44,-.35)*f1_3+
    vec4(-.58,-.22,3.24,.10))/1.4+f1_3;
vec4 f3_0=sin(mat4(-.25,.28,-.08,.32,-.08,.47,-.52,-.36,.34,-.30,.01,-.40,.41,-.31,.40,.35)*f2_0+
    mat4(.15,.21,-.06,.53,.16,-.35,-.08,-.27,.31,.14,.09,.30,-.02,.28,.22,-.36)*f2_1+
    mat4(-.10,-.13,-.13,-.61,-.55,.31,.02,.39,.09,-.11,-.27,.32,.41,-.09,-.02,-.04)*f2_2+
    mat4(.46,.67,-.11,-.05,.39,-.36,.51,.14,-.72,.58,.02,.47,-.32,-.02,-.15,-.46)*f2_3+
    vec4(.22,.97,.83,-1.94))/1.7+f2_0;
vec4 f3_1=sin(mat4(.14,-.43,-.07,-.30,-.06,-.13,-.22,-.22,.22,.39,.57,-.30,-.14,.23,.08,-.04)*f2_0+
    mat4(-.57,-.22,-.54,-.63,.03,-.36,.42,.17,.07,.21,.51,.16,.31,-.49,.19,-.14)*f2_1+
    mat4(.20,-.06,-.33,-.01,-.01,-.43,-.12,-.02,-.73,-.27,.44,.20,.04,-.05,-.21,.18)*f2_2+
    mat4(-.19,-.23,.11,-.42,.44,-.35,.30,.71,.45,.12,.05,-.29,-.10,.57,-.09,-.27)*f2_3+
    vec4(2.08,1.81,.22,2.10))/1.7+f2_1;
vec4 f3_2=sin(mat4(-.12,.74,.20,-.02,.36,.07,-.10,-.01,.49,.07,-.54,-.03,-.01,-.30,.13,-.07)*f2_0+
    mat4(-.29,-.08,-.50,-.57,.06,.49,.43,.33,-.20,-.60,-.32,-.14,.02,-.10,.42,.48)*f2_1+
    mat4(.02,.17,.45,-.01,-.50,.30,.34,-.22,.37,.51,.60,.56,-.16,-.16,.40,.84)*f2_2+
    mat4(.77,.56,.23,.61,-.13,-.26,.70,-.12,.38,.50,.71,.22,.09,.06,-.39,-.32)*f2_3+
    vec4(-1.70,2.89,-1.61,-2.98))/1.7+f2_2;
vec4 f3_3=sin(mat4(.25,.37,.07,-.17,-.72,-.24,.06,.27,.79,.39,.38,.77,-.19,.20,.10,-.05)*f2_0+
    mat4(.18,.05,-.30,-.22,.01,.24,.37,-.10,.46,-.57,-.71,-.01,.10,.12,.18,-.60)*f2_1+
    mat4(.32,.12,-.17,.23,.40,-.53,-.24,-.22,.28,.58,.30,.26,-.38,.40,-.15,-.17)*f2_2+
    mat4(.05,.02,1.01,.46,-.24,.17,.36,.76,-.24,-.31,-.53,.59,-.43,-.27,-.37,.44)*f2_3+
    vec4(.55,.75,-2.43,.70))/1.7+f2_3;
vec4 f4_0=sin(mat4(-1.00,-.71,.35,-.99,.08,-.49,-.01,-.58,.76,-.18,-.13,-.22,.47,.12,-.23,-.14)*f3_0+
    mat4(-.85,-.67,-.03,.06,.46,.21,.16,-.03,-.18,.28,-.51,-.22,.38,.18,-.48,-.13)*f3_1+
    mat4(-.00,-.21,-.46,-.39,-.53,.13,.36,-.31,-.36,-.07,.43,.38,-.50,.27,-.00,.62)*f3_2+
    mat4(.59,-.08,-.17,-.49,-.01,-.29,-.88,.18,-.79,.50,.49,-.17,.31,-.23,.59,-.35)*f3_3+
    vec4(-1.02,.93,-1.68,.83))/2.0+f3_0;
vec4 f4_1=sin(mat4(-.24,.06,-.61,-.45,-.14,-.32,-.36,.44,-1.33,.06,.51,.19,-.74,.53,-.21,.03)*f3_0+
    mat4(-.74,-.62,.51,.66,.13,-.26,-.23,-.39,.34,.09,.28,.37,.23,.41,-.20,.27)*f3_1+
    mat4(-.53,-.20,-.24,.38,.48,.36,-.33,-.51,-.21,.35,-.16,-.77,.33,.35,.00,-.28)*f3_2+
    mat4(-.05,.06,-.32,.62,-.09,.66,-1.20,-.17,.08,-.06,.36,.13,-.58,-.59,.25,.11)*f3_3+
    vec4(-2.58,-.60,-.24,-.51))/2.0+f3_1;
vec4 f4_2=sin(mat4(-.28,-.17,-.40,-.11,.10,.54,.09,-.07,.20,-.18,.51,.24,.37,-.54,.25,.02)*f3_0+
    mat4(-.19,.43,-.42,.04,.40,-.66,-.82,.47,-.02,.96,.31,.41,.06,.09,-.34,-.57)*f3_1+
    mat4(-.44,-.03,.45,.29,-.08,.54,-.17,.19,-.99,-.46,.49,-.05,-.80,.01,-1.14,-.07)*f3_2+
    mat4(.44,-.61,-.38,-.76,-.39,-.57,-.16,.07,-.26,.06,-.61,-.53,.33,.56,.42,.57)*f3_3+
    vec4(-2.35,-2.02,2.99,.51))/2.0+f3_2;
vec4 f4_3=sin(mat4(-.24,.39,.33,-.21,.26,.46,.08,-.12,.11,-.32,-.06,-1.36,.23,.20,.25,.08)*f3_0+
    mat4(-.28,.13,-.40,-.30,.34,-.36,-.03,.19,-.17,.75,-.42,.30,-.21,.20,-.34,.51)*f3_1+
    mat4(-.36,-.43,.38,-.20,.28,.17,-.02,.03,.22,-.50,-.35,-.52,.10,-.36,-.33,-.06)*f3_2+
    mat4(-.06,.08,-.29,.19,-.03,-.14,.48,.22,-.10,-.19,-.19,.19,.25,.08,.41,.20)*f3_3+
    vec4(.69,-1.78,3.36,-2.24))/2.0+f3_3;
return dot(f4_0,vec4(-.04,.05,.06,.03))+
    dot(f4_1,vec4(.02,-.05,-.03,.03))+
    dot(f4_2,vec4(-.05,.02,.01,-.04))+
    dot(f4_3,vec4(.00,-.06,.07,.02))+
    -0.218;
}

vec3 norm(vec3 p) {
    mat3 k = mat3(p, p, p) - mat3(0.001);
    return normalize(scene(p) - vec3(scene(k[0]),scene(k[1]),scene(k[2])));
}

void main( )
{
    vec2 uv = (gl_FragCoord.xy-.5*u_resolution.xy)/u_resolution.y;
    vec3 cam = normalize(vec3(1.5,uv));
    vec3 init = vec3(-3.,0,0);
    
    float yrot = 0.5;
    float zrot = u_time*.2;
   
    cam = erot(cam, vec3(0,1,0), yrot);
    init = erot(init, vec3(0,1,0), yrot);
    cam = erot(cam, vec3(0,0,1), zrot);
    init = erot(init, vec3(0,0,1), zrot);
    
    vec3 p = init;
    bool hit = false;
    for (int i = 0; i < 150 && !hit; i++) {
        float dist = scene(p);
        hit = dist*dist < 1e-6;
        p+=dist*cam;
        if (distance(p,init)>5.) break;
    }
    vec3 n = norm(p);
    vec3 r = reflect(cam,n);
    //don't ask how I stumbled on this texture
    vec3 nz = p - erot(p, vec3(1), 2.) + erot(p, vec3(1), 4.);
    float spec = length(sin(r*3.5+sin(nz*120.)*.15)*.4+.6)/sqrt(3.);
    spec *= smoothstep(-.3,.2,scene(p+r*.2));
    vec3 col = vec3(.1,.1,.12)*spec + pow(spec,8.);
    float bgdot = length(sin(cam*8.)*.4+.6)/2.;
    vec3 bg = vec3(.1,.1,.11) * bgdot + pow(bgdot, 10.);
    out_colour.xyz = hit ? col : bg;
    out_colour = smoothstep(-.02,1.05,sqrt(out_colour)) * (1.- dot(uv,uv)*.5);
    out_colour.w = 1.0;
}